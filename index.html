<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRS Leaderboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 2em;
            background-color: #f4f6f8;
        }
        h1 {
            color: #222;
            text-align: center;
            margin-bottom: 1em;
        }
        .nav-links {
            text-align: center;
            margin-bottom: 2em;
        }
        .nav-links a {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        .nav-links a:hover {
            background: #c82333;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 2em;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            min-width: 150px;
        }
        select:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
        }
        table {
            width: 90%;
            margin: 0 auto;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        th {
            background: linear-gradient(90deg, #007bff, #00a2ff);
            color: white;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
            padding: 14px;
            text-align: left;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        tr:hover td {
            background-color: #eaf4ff;
        }
        .rank-1 td:first-child {
            color: gold;
            font-weight: bold;
            font-size: 18px;
        }
        .rank-2 td:first-child {
            color: silver;
            font-weight: bold;
            font-size: 18px;
        }
        .rank-3 td:first-child {
            color: #cd7f32;
            font-weight: bold;
            font-size: 18px;
        }
        details summary {
            cursor: pointer;
            font-weight: 600;
            color: #007bff;
            padding: 5px 0;
        }
        details summary:hover {
            color: #0056b3;
        }
        .details-container {
            padding: 10px 0 0 20px;
            font-size: 0.9em;
            color: #555;
            animation: fadeIn 0.3s ease-in-out;
            line-height: 1.6;
        }
        .details-container p {
            margin: 5px 0;
        }
        .details-container strong {
            color: #333;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-3px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .description-box {
            width: 85%;
            margin: 20px auto 0;
            padding: 15px 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.05);
            font-size: 14px;
            line-height: 1.5;
            color: #444;
        }
        .description-box h2 {
            margin-top: 0;
            font-size: 16px;
            color: #007bff;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 20px 0;
        }
        .error {
            text-align: center;
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            margin: 20px auto;
            width: 85%;
        }
        .current-mode {
            text-align: center;
            color: #007bff;
            font-weight: 600;
            margin: 10px 0;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>CRS Leaderboard</h1>

    <div class="nav-links">
        <a href="challenges.html">View Challenges</a>
        <a href="contact.html">Contact Us</a>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="rankingType">Ranking Type:</label>
            <select id="rankingType" onchange="updateRanking()">
                <option value="All">Overall Ranking (All Modes)</option>
                <option value="programming">By Programming Language</option>
                <option value="challenge">By Challenge Type</option>
            </select>
        </div>
        
        <div class="control-group" id="programmingSelector" style="display: none;">
            <label for="programmingMode">Programming Language:</label>
            <select id="programmingMode" onchange="updateRanking()">
                <option value="C-Mode">C-Mode</option>
                <option value="Java-Mode">Java-Mode</option>
            </select>
        </div>
        
        <div class="control-group" id="challengeSelector" style="display: none;">
            <label for="challengeMode">Challenge Type:</label>
            <select id="challengeMode" onchange="updateRanking()">
                <option value="Full-Mode">Full-Mode</option>
                <option value="Delta-Mode">Delta-Mode</option>
            </select>
        </div>
    </div>

    <div class="current-mode" id="currentMode">Currently showing: Overall Ranking (All Modes)</div>

    <div id="leaderboard">
        <div class="loading">Loading leaderboard data...</div>
    </div>

    <div class="description-box">
        <h2>About This Leaderboard</h2>
        <p>
            This leaderboard displays the performance of AI models across different CRS challenges. 
            Models are ranked by their total scores, which are calculated based on their ability to find 
            vulnerabilities (POVs) and generate patches. Click on any model name to view detailed 
            information about the specific vulnerabilities found and patches generated.
        </p>
        <p>
            <strong>Scoring:</strong> Total score = POVs Ã— 2 + patches Ã— 6
        </p>
    </div>

    <script>
        // Global variables
        let allData = [];
        let currentRankingType = 'All';
        let currentSubMode = '';

        // Parse CSV string to array of objects
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }

        // Generate rank emoji
        function getRankEmoji(rank) {
            switch(rank) {
                case 1: return 'ðŸ†';
                case 2: return 'ðŸ¥ˆ';
                case 3: return 'ðŸ¥‰';
                default: return '';
            }
        }

        // Filter data based on current ranking type and mode
        function filterData() {
            if (currentRankingType === 'All') {
                return allData.filter(row => row.Mode === 'All');
            } else if (currentRankingType === 'programming') {
                return allData.filter(row => row.Mode === currentSubMode);
            } else if (currentRankingType === 'challenge') {
                return allData.filter(row => row.Mode === currentSubMode);
            }
            return [];
        }

        // Create leaderboard table from filtered data
        function createLeaderboardTable(data) {
            if (!data || data.length === 0) {
                return '<div class="error">No data available for the selected mode.</div>';
            }

            // Sort data by total score (descending)
            const sortedData = data.sort((a, b) => {
                const scoreA = parseInt(a.TotalScore || 0);
                const scoreB = parseInt(b.TotalScore || 0);
                return scoreB - scoreA;
            });

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Model</th>
                            <th>Total Score</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedData.forEach((row, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const rankEmoji = getRankEmoji(rank);
                
                const modelName = row.Model || 'Unknown Model';
                const totalScore = row.TotalScore || 0;
                const povFound = row['POV Found'] || '';
                const patchFound = row['Patch Found'] || '';

                tableHTML += `
                    <tr class="${rankClass}">
                        <td>${rank} ${rankEmoji}</td>
                        <td>
                            <details>
                                <summary>${modelName}</summary>
                                <div class="details-container">
                                    <p><strong>POV Found:</strong></p>
                                    <p style="margin-left: 10px; font-family: monospace; font-size: 0.85em;">${povFound || 'None'}</p>
                                    <p><strong>Patch Found:</strong></p>
                                    <p style="margin-left: 10px; font-family: monospace; font-size: 0.85em;">${patchFound || 'None'}</p>
                                </div>
                            </details>
                        </td>
                        <td>${totalScore}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            return tableHTML;
        }

        // Update the ranking display
        function updateRanking() {
            const rankingType = document.getElementById('rankingType').value;
            const programmingSelector = document.getElementById('programmingSelector');
            const challengeSelector = document.getElementById('challengeSelector');
            const currentModeDiv = document.getElementById('currentMode');

            // Hide all selectors initially
            programmingSelector.style.display = 'none';
            challengeSelector.style.display = 'none';

            // Show appropriate selector and update current mode
            if (rankingType === 'programming') {
                programmingSelector.style.display = 'flex';
                currentSubMode = document.getElementById('programmingMode').value;
                currentModeDiv.textContent = `Currently showing: ${currentSubMode}`;
            } else if (rankingType === 'challenge') {
                challengeSelector.style.display = 'flex';
                currentSubMode = document.getElementById('challengeMode').value;
                currentModeDiv.textContent = `Currently showing: ${currentSubMode}`;
            } else {
                currentSubMode = '';
                currentModeDiv.textContent = 'Currently showing: Overall Ranking (All Modes)';
            }

            currentRankingType = rankingType;
            
            // Update the leaderboard
            const filteredData = filterData();
            const leaderboardDiv = document.getElementById('leaderboard');
            leaderboardDiv.innerHTML = createLeaderboardTable(filteredData);
        }

        // Load CSV data
        async function loadCSVData() {
            try {
                const response = await fetch('./data/results.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                allData = parseCSV(csvText);
                return true;
            } catch (error) {
                console.error('Error loading CSV data:', error);
                document.getElementById('leaderboard').innerHTML = `
                    <div class="error">
                        Failed to load data. Please check if the CSV file exists at: ./data/results.csv
                    </div>
                `;
                return false;
            }
        }

        // Initialize the page
        async function initializePage() {
            const success = await loadCSVData();
            if (success) {
                updateRanking();
            }
        }

        // Start the application when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
